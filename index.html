<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">    
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js"></script>
    <script src="bundle.js"></script>
    <script type="text/javascript">
       $(document).ready(function () {
           console.log("doc ready");
           var newLineArr = [];
           var connections = [];
           var targetId = 0;
           const params = new Map(location.search.slice(1).split('&').map(kv => kv.split('=')));
           if(params.has('id')){
            targetId = params.get('id');
                if(targetId!= undefined){
                    $("#share").hide();
                }
           }

        var simplemde = new SimpleMDE({
            toolbar : false,
            element: $("textarea#id1")[0],
            initialValue: "",
        });
        simplemde.codemirror.on("change", function(changeObj, obj2){
            //$("#regTitle").html(simplemde.value());
            var cm = simplemde.codemirror;
            var position = obj2.from.ch;
            if(obj2.text[0] == "" && obj2.origin == "+input")
            {
                if(newLineArr.length == 0){
                    newLineArr.push(obj2.from.ch);
                }
                else{
                    //var ind = newLineArr.length-1;
                    var ind = newLineArr[newLineArr.length-1];
                    position = ind + obj2.from.ch+1;
                    newLineArr.push(position);
                }
            }
            else if(newLineArr.length > 0){
                var ind = newLineArr[newLineArr.length-1];
                position = ind + position+1;
            }
            LogData(position, obj2.text[0], obj2.origin, connections);
        });

        var conn;
        var peer = new Peer({key: 'api'});
        peer.on('open', function(id){
            console.log('peer id: '+peer.id);
            createController(peer.id); 
            if(targetId != 0){
            		console.log("target not 0");
                var c = peer.connect(targetId);
					c.on('open', function(){
                        connect(c);
                        //Sending my peer id to the connecting id
                        conn.send("Data:"+peer.id);
					});
            } 
        });
        peer.on('connection', connect);   
        function connect(c){
            conn = c
            conn.on('data',function(data){
                console.log(data);
                if(data.startsWith("Data")){
                    var incomingPeerId = data.split(":")[1];
                    // Adding the connecting peer to my list of connections
                    if(connections != undefined || !connections.id.includes(incomingPeerId)){
                        console.log("log incom id "+incomingPeerId);
                        connections.push({"id":incomingPeerId, "conn":conn});
                        console.log(connections);
                    }
                    //Sending my current existing objects to the connecting peer id
                    //(peerid,connections list, struct, version)
                    var crdt = fetchCrdt();
                    crdt = JSON.stringify(crdt);
                    //connJSON = JSON.stringify(connections);
                    conn.send("Initial crdt:"+crdt);
                    //conn.send("Connection list:"+connJSON);
                }
                if(data.startsWith("Initial crdt")){
                    var crdt = data.replace("Initial crdt:",""); 
                    crdt = JSON.parse(crdt); 
                    if(crdt.struct!=undefined){
                        console.log("Receiving the initial struct");
                        console.log(crdt.struct);
                        //Assign it to my struct
                        syncStruct(crdt.struct,crdt.text);
                        //Assign the text to my editor
                        simplemde.value(crdt.text); 
                    }
                    else{
                        console.log("Struct is undefined");
                        console.log(crdt);
                    }                    
                }
                if(data.startsWith("Connection list")){
                    var connect = data.replace("Connection list:",""); 
                    connect = JSON.parse(connect);                 
                }
                if(data.startsWith("Insert")) {
                		var connect = data.replace("Insert:","");
                		console.log("HTML remote "+JSON.parse(connect).Insert.value);
                		LogRemoteInsertData(JSON.parse(connect).Insert, connect);
                }
            });
            conn.on('close', disconnect);
        }

        function disconnect(){
            if (conn.peer) {
                conn.peer = null;
                conn.close();
            }
        }
        
        $('#share').on("click", function () {
            getURL();
        });
    });
        
    </script>
    <title>Distributed Editor</title>
    <style>
        body { padding-top: 70px; }

        #editor {
        width:100%;
        height:480px;
        display:block;
        box-sizing: border-box;
        }

        body {
            background: #D1F0B2;
            font-family: 'Montserrat', sans-serif;
        }

            body > div {
                padding: 10px;
                margin: auto;
            }

        textarea {
            width: 75%;
            height: 650px;
            background: #FAFBF9;
            margin-top: 14px;
            overflow: hidden;
        }

        h2,
        h1 {
            color: #4F9329;
        }
    
    </style>
</head>

<body>
    <div>

        <h1>Distributed Text Editor</h1>
        <hr>
        <div class="hide" id="conclave">
                <div class="text-wrapper">
                    <div class="editor">
                        <div class="header"><button id="share">Share URL</button>
                            <div id="url"></div>
        <textarea id = "id1"></textarea></div></div></div></div>
        <p>
            <i>Decentralized Real-Time Collaborative Editor using CRDT</i>
        </p>
        <!--
        <div id="editor"></div>  
        --> 
        <!--
        <script src="http://ace.c9.io/build/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
            -->
        <script>
        
        // var editor = ace.edit("editor");
        // editor.setTheme("ace/theme/chrome");
        
        
            // editor.getSession().on('change', function(e){
            //     var pos = editor.selection.getCursor();
            //     var index = editor.getSession().getDocument().positionToIndex(pos);
            //     console.log(index+" at: "+e.lines[0]);
            //     //e.action = 'insert';
            //     $.get("/updateCrdt", { val: e.lines[0], index: index, action:e.action }, function (data) { });
                
            // });
        </script>

        <!-- <textarea id="textArea1" placeholder="start typing..."></textarea> -->
        <br>
        <br>
        <div>
            
    </div>
        </div>
</body>

</html>